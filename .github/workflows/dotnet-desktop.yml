name: .NET CI

on:
  push:
  pull_request:

jobs:
  # 1) V√©rifie que le message du dernier commit contient un emoji spatial (üöÄ, üõ∏ ou ü™ê)
  commit-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du d√©p√¥t avec tout l‚Äôhistorique
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: D√©terminer la SHA √† checker
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "COMMIT_REF=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          else
            echo "COMMIT_REF=${{ github.sha }}" >> $GITHUB_ENV
          fi

      - name: Le commit du cosmonaute
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B "$COMMIT_REF")
          if ! [[ "$COMMIT_MSG" =~ (üöÄ|üõ∏|ü™ê) ]]; then
            echo "::error::Le message de commit doit contenir au moins un emoji spatial (üöÄ, üõ∏ ou ü™ê)"
            exit 1
          fi

  # 2) Build .NET, tests et notifications
  build:
    runs-on: windows-latest
    needs: commit-check
    steps:
      - uses: actions/checkout@v4

      - name: Installer .NET 7.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 7.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: dotnet restore
        run: dotnet restore

      - name: Test
        id: run-tests
        run: dotnet test
        continue-on-error: true

      # Succ√®s : GIF de soleil
      - name: La m√©t√©o des tests - Succ√®s
        if: steps.run-tests.outcome == 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚òÄÔ∏è Tous les tests ont pass√©!",
              "attachments": [
                {
                  "image_url": "https://media.giphy.com/media/XWXnf6hRiKBJS/giphy.gif"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # √âchec : GIF d‚Äôorage
      - name: La m√©t√©o des tests - √âchec
        if: steps.run-tests.outcome != 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ö° Alerte! Certains tests ont √©chou√©!",
              "attachments": [
                {
                  "image_url": "https://media.giphy.com/media/3o7TKqnN349PBUtGFO/giphy.gif"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # En cas d‚Äô√©chec, on poste un commentaire Alien sur la PR
      - name: Alien Code Review
        if: steps.run-tests.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üëΩ Humain, ton code est incompr√©hensible pour ma civilisation. Peux-tu ajouter des tests ?