name: .NET CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  validate-commit-message:
    name: ðŸ”Ž Valider le message de commit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: VÃ©rifier la prÃ©sence dâ€™un emoji spatial
        shell: bash
        run: |
          MSG="$(git log -1 --pretty=%B)"
          echo "Message de commit : $MSG"
          if ! echo "$MSG" | grep -qE 'ðŸš€|ðŸ‘½|ðŸª'; then
            echo "::error::Le message de commit doit contenir au moins un emoji spatial (ðŸš€,ðŸ‘½,ðŸª)."
            exit 1
          fi

  build:
    name: ðŸ—ï¸ Build & Test
    runs-on: windows-latest
    needs: validate-commit-message
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '7.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Run tests
        id: dotnet-test
        run: |
          if dotnet test; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

    test-weather:
      name: ðŸŒ¦ï¸ La mÃ©tÃ©o des tests
      runs-on: ubuntu-latest
      needs: build
      if: always()
      steps:
        - name: Choisir le GIF et le message
  -        id: mÃ©tÃ©o
  +        id: meteo
          shell: bash
          run: |
            if [ "${{ needs.build.outputs.status }}" = "success" ]; then
              GIF="https://media.giphy.com/media/26tPplGWjN0xLybiU/giphy.gif"
              TEXTE="â˜€ï¸ Tous les tests sont passÃ©sÂ ! Bravo !"
            else
              GIF="https://media.giphy.com/media/l4EoZVMBY5J4S4xR2/giphy.gif"
              TEXTE="â›ˆï¸ Oups, certains tests ont Ã©chouÃ©â€¦"
            fi
            echo "gif=$GIF" >> $GITHUB_OUTPUT
            echo "texte=$TEXTE" >> $GITHUB_OUTPUT
  
        - name: Envoyer notification sur Slack
          uses: 8398a7/action-slack@v3
          with:
            status: ${{ needs.build.result }}
            fields: workflow,job,commit,repo,author
            custom_payload: |
              {
                "text": "${{ steps.meteo.outputs.texte }}",
                "attachments": [
                  { "image_url": "${{ steps.meteo.outputs.gif }}" }
                ]
              }
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
       

  alien-code-review:
    name: ðŸ‘½ Alien Code Review
    runs-on: ubuntu-latest
    needs: build
    if: failure()
    steps:
      - name: GÃ©nÃ©rer un commentaire alÃ©atoire
        id: random-comment
        shell: bash
        run: |
          COMMENTS=(
            "ðŸ‘½ Humain, ton code est incomprÃ©hensible pour ma civilisation. Peux-tu ajouter des testsÂ ?"
            "ðŸ‘¾ Attention, j'ai dÃ©tectÃ© des perturbations dans ton code. Des tests aideraientÂ !"
            "ðŸ›¸ Ce code a l'air d'Ãªtre sorti d'une autre dimension. Ajoute des tests, stpÂ !"
          )
          INDEX=$(( RANDOM % ${#COMMENTS[@]} ))
          echo "comment=${COMMENTS[$INDEX]}" >> $GITHUB_OUTPUT

      - name: Poster le commentaire sur la PR
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.random-comment.outputs.comment }}
