name: .NET CI

on: [push, pull_request]

jobs:
  # VÃ©rifie que le message de commit contient un emoji spatial (ğŸš€, ğŸ›¸ ou ğŸª)
  commit-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Le commit du cosmonaute
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if ! [[ $COMMIT_MSG =~ (ğŸš€|ğŸ›¸|ğŸª) ]]; then
            echo "::error::Le message de commit doit contenir au moins un emoji spatial (ğŸš€, ğŸ›¸ ou ğŸª)"
            exit 1
          fi

  build:
    runs-on: windows-latest
    needs: commit-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 7.0.x
      # Met en cache les packages NuGet pour accÃ©lÃ©rer les builds suivants
      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - run: dotnet restore
      - name: Test
        id: run-tests
        run: dotnet test
        continue-on-error: true
      # Envoie un GIF de soleil â˜€ï¸ ou d'orage âš¡ Ã  Slack selon le rÃ©sultat des tests
      - name: La mÃ©tÃ©o des tests - SuccÃ¨s
        if: steps.run-tests.outcome == 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "â˜€ï¸ Tous les tests ont passÃ©!",
              "attachments": [
                {
                  "image_url": "https://media.giphy.com/media/XWXnf6hRiKBJS/giphy.gif"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
          
      - name: La mÃ©tÃ©o des tests - Ã‰chec
        if: steps.run-tests.outcome != 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âš¡ Alerte! Certains tests ont Ã©chouÃ©!",
              "attachments": [
                {
                  "image_url": "https://media.giphy.com/media/3o7TKqnN349PBUtGFO/giphy.gif"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
      # Ajoute un commentaire alien ğŸ‘½ en cas d'Ã©chec des tests
      - name: Alien Code Review
        if: steps.run-tests.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ğŸ‘½ Humain, ton code est incomprÃ©hensible pour ma civilisation. Peux-tu ajouter des tests ?