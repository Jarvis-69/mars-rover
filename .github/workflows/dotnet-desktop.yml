name: .NET CI

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 7.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      # Nouveau pas pour vÃ©rifier les vulnÃ©rabilitÃ©s
      - name: VÃ©rifier les dÃ©pendances vulnÃ©rables
        shell : bash
        run: |
          # ExÃ©cute la vÃ©rification des vulnÃ©rabilitÃ©s et capture le code de sortie
          # La commande retourne un code non nul si des vulnÃ©rabilitÃ©s sont trouvÃ©es.
          dotnet list package --vulnerable --include-transitive
          exit_code=$?

          # VÃ©rifie le code de sortie
          if [ $exit_code -ne 0 ]; then
            echo "âŒ Des dÃ©pendances vulnÃ©rables ont Ã©tÃ© dÃ©tectÃ©es (ou la commande a Ã©chouÃ©)."
            # La sortie de la commande dotnet list est dÃ©jÃ  affichÃ©e ci-dessus.
            exit $exit_code
          else
            echo "âœ… Aucune dÃ©pendance vulnÃ©rable dÃ©tectÃ©e."
          fi

      - name: Run tests with emoji feedback
        shell: bash
        run: |
          set +e
          # ExÃ©cute les tests et capture la sortie
          output=$(dotnet test 2>&1)
          exit_code=$?

          # Choix de l'emoji et du message selon le code de retour
          if [ $exit_code -eq 0 ]; then
            emoji="â˜€ï¸"
            message="Tous les tests ont rÃ©ussi !"
          else
            emoji="â›ˆï¸"
            message="Des tests ont Ã©chouÃ© !"

            # Ã€ chaque Ã©chec, avec probabilitÃ© ~50%, un message alien
            if [ $((RANDOM % 2)) -eq 0 ]; then
              echo "ğŸ‘½ Humain, ton code est incomprÃ©hensible pour ma civilisation. Peux-tu ajouter des testsÂ ?"
            fi
          fi

          # Affiche emoji + message
          echo "${emoji}  ${message}"

          # VÃ©rifie qu'il y ait bien au moins un des deux emoji
          if ! echo "${emoji}  ${message}" | grep -q '[â˜€ï¸â›ˆï¸]'; then
            echo "âš ï¸  Aucun emoji dÃ©tectÃ© dans la sortieÂ !"
            exit 1
          fi

          # RÃ©affiche les logs de dotnet test (optionnel)
          echo "$output"

          # Fait Ã©chouer le job si les tests ont Ã©chouÃ©
          exit $exit_code