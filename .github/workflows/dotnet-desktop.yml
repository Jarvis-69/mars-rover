name: .NET CI

on: [push, pull_request]

jobs:
  # Vérifie que le message de commit contient un emoji spatial (🚀, 🛸 ou 🪐)
  commit-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Le commit du cosmonaute
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if ! [[ $COMMIT_MSG =~ (🚀|🛸|🪐) ]]; then
            echo "::error::Le message de commit doit contenir au moins un emoji spatial (🚀, 🛸 ou 🪐)"
            exit 1
          fi

  build:
    runs-on: windows-latest
    needs: commit-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 7.0.x
      # Met en cache les packages NuGet pour accélérer les builds suivants
      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.fsproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - run: dotnet restore
      - name: Test
        id: run-tests
        run: dotnet test
        continue-on-error: true
      # Envoie un GIF de soleil ☀️ ou d'orage ⚡ à Slack selon le résultat des tests
      - name: La météo des tests - Succès
        if: steps.run-tests.outcome == 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "☀️ Tous les tests ont passé!",
              "attachments": [
                {
                  "image_url": "https://media.giphy.com/media/XWXnf6hRiKBJS/giphy.gif"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
          
      - name: La météo des tests - Échec
        if: steps.run-tests.outcome != 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "⚡ Alerte! Certains tests ont échoué!",
              "attachments": [
                {
                  "image_url": "https://media.giphy.com/media/3o7TKqnN349PBUtGFO/giphy.gif"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
      # Ajoute un commentaire alien 👽 en cas d'échec des tests
      - name: Alien Code Review
        if: steps.run-tests.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            👽 Humain, ton code est incompréhensible pour ma civilisation. Peux-tu ajouter des tests ?